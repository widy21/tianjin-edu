<!DOCTYPE html>
<html>
<head>
    <title>å…¬å¯“æ™šå½’æ•°æ®æŸ¥è¯¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            color: #333;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-bar {
            background: #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .top-bar .logo {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
        }
        .top-bar .logo span { color: #4CAF50; }
        .top-bar .user-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .top-bar .user-name {
            font-size: 15px;
            color: #666;
        }
        .top-bar .user-name strong { color: #333; }
        .top-bar a.action-link {
            font-size: 14px;
            text-decoration: none;
            padding: 6px 14px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        a.action-link.admin-link {
            color: #1976D2;
            background: #E3F2FD;
        }
        a.action-link.admin-link:hover { background: #BBDEFB; }
        a.action-link.logout-link {
            color: #e53935;
            background: #FFEBEE;
        }
        a.action-link.logout-link:hover { background: #FFCDD2; }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            max-width: 960px;
            margin: 24px auto;
            padding: 0 16px;
        }

        /* æ›´æ–°æ—¥å¿—æŠ˜å  */
        .changelog {
            background: #fff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-left: 3px solid #2196F3;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            user-select: none;
        }
        .changelog summary {
            font-size: 14px;
            color: #999;
            outline: none;
        }
        .changelog p { margin: 4px 0; color: #2196F3; }

        /* å¡ç‰‡ */
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            padding: 24px;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* æ¥¼æ ‹é€‰æ‹©åŒº */
        .building-section {
            margin-bottom: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .building-label {
            font-size: 14px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            white-space: nowrap;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .building-label.zhongyuan { background: #E3F2FD; color: #1565C0; }
        .building-label.xiyuan { background: #E8F5E9; color: #2E7D32; }
        .toggle-btn {
            font-size: 13px;
            padding: 3px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
            cursor: pointer;
            color: #666;
            white-space: nowrap;
            flex-shrink: 0;
            margin-top: 2px;
            transition: all 0.15s;
        }
        .toggle-btn:hover { background: #f0f0f0; border-color: #bbb; }
        .checkbox-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 4px 12px;
        }
        .checkbox-grid label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: #555;
            cursor: pointer;
            padding: 3px 0;
        }
        .checkbox-grid input[type="checkbox"] {
            width: 15px;
            height: 15px;
            accent-color: #4CAF50;
            cursor: pointer;
        }
        .selected-info {
            font-size: 14px;
            color: #4CAF50;
            font-weight: 500;
            margin-top: 8px;
            min-height: 20px;
        }

        /* æ—¶é—´é€‰æ‹© */
        .time-row {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        .time-row label {
            font-size: 14px;
            color: #666;
            margin-right: 6px;
        }
        .time-row input[type="time"] {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            outline: none;
            transition: border-color 0.2s;
        }
        .time-row input[type="time"]:focus { border-color: #4CAF50; }

        /* ä¸‹è½½åŒº */
        .download-area {
            font-size: 14px;
            color: #666;
            min-height: 24px;
        }
        .download-area a {
            color: #1976D2;
            text-decoration: none;
            font-weight: 500;
        }
        .download-area a:hover { text-decoration: underline; }

        /* æŒ‰é’® */
        .btn-row {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 36px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #4CAF50; color: #fff; }
        .btn-primary:hover { background: #43A047; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-reset { background: #f5f5f5; color: #666; border: 1px solid #ddd; }
        .btn-reset:hover { background: #eee; }
    </style>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="top-bar">
    <div class="logo"><span>ğŸ“Š</span> å…¬å¯“æ™šå½’æ•°æ®ç®¡ç†</div>
    <div class="user-actions">
        <span class="user-name">æ¬¢è¿ï¼Œ<strong>{{ username }}</strong></span>
        {% if is_admin %}<a href="{{ url_for('admin.admin_page') }}" class="action-link admin-link">âš™ ç³»ç»Ÿç®¡ç†</a>{% endif %}
        <a href="{{ url_for('logout') }}" class="action-link logout-link">é€€å‡ºç™»å½•</a>
    </div>
</div>

<!-- ä¸»å†…å®¹ -->
<div class="main-content">

    <!-- æ›´æ–°æ—¥å¿— -->
    <details class="changelog">
        <summary>ğŸ“‹ æ›´æ–°æ—¥å¿—</summary>
        <p>2026-02-17ï¼šæ–°å¢è‡ªåŠ¨å®šæ—¶é‚®ä»¶ä»»åŠ¡ï¼ˆæ”¯æŒCronè¡¨è¾¾å¼é…ç½®ï¼‰ï¼›æ–°å¢ç³»ç»Ÿç®¡ç†åå°ï¼ˆç”¨æˆ·ç®¡ç†ã€æƒé™é…ç½®ã€æ¥¼æ ‹æƒé™ã€é‚®ä»¶ä»»åŠ¡ã€ç³»ç»Ÿé…ç½®ã€æ“ä½œæ—¥å¿—ï¼‰ï¼›æ”¯æŒæŒ‰ç”¨æˆ·åˆ†é…å¯æ“ä½œæ¥¼æ ‹ã€‚</p>
        <p>2025-12-04ï¼šæ–°å¢è¥¿é™¢å…¬å¯“ï¼ˆ13-17Bæ ‹ï¼‰ï¼›æ–°å¢å…¨é€‰/åé€‰æŒ‰é’®ï¼›æŒ‰é’®é˜²é‡å¤ç‚¹å‡»ã€‚</p>
        <p>2025-05-30ï¼šå¯¼å‡ºæ•°æ®ä¸­åªä¿ç•™æ¯ä¸ªå­¦ç”Ÿæœ€æ™šæ‰“å¡è®°å½•ã€‚</p>
        <p>2025-05-29ï¼šæ”¯æŒä¸åŒç”¨æˆ·åŒæ—¶æ“ä½œã€‚</p>
    </details>

    <form id="queryForm" onsubmit="handleSubmit(event)">
        <!-- æ¥¼æ ‹é€‰æ‹©å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">
                å…¬å¯“æ¥¼æ ‹é€‰æ‹©
                {% if has_admin_perm %}<button type="button" class="toggle-btn" onclick="toggleAllBuildings()" style="float:right;">å…¨é€‰/åé€‰</button>{% endif %}
            </div>

            {% set zy_buildings = [] %}
            {% for i in range(14) %}
                {% if not allowed_buildings or (i+1)|string in allowed_buildings %}
                    {% if zy_buildings.append(i+1) %}{% endif %}
                {% endif %}
            {% endfor %}
            {% set xy_buildings = [] %}
            {% set xy_map = {15:'13æ ‹', 16:'14æ ‹', 17:'15æ ‹', 18:'16æ ‹', 19:'17Aæ ‹', 20:'17Bæ ‹'} %}
            {% for v in [15,16,17,18,19,20] %}
                {% if not allowed_buildings or v|string in allowed_buildings %}
                    {% if xy_buildings.append(v) %}{% endif %}
                {% endif %}
            {% endfor %}

            <!-- ä¸­é™¢ -->
            {% if zy_buildings %}
            <div class="building-section">
                <span class="building-label zhongyuan">ä¸­é™¢</span>
                {% if has_admin_perm %}<button type="button" class="toggle-btn" onclick="toggleZhongyuan()">å…¨é€‰/åé€‰</button>{% endif %}
                <div class="checkbox-grid" id="zhongyuan-buildings">
                    {% for i in range(14) %}
                        {% if not allowed_buildings or (i+1)|string in allowed_buildings %}
                            {% if i == 10 %}
                                <label><input type="checkbox" name="building" value="{{ i+1 }}" onchange="updateSelectedBuildings()"> 11Aæ ‹</label>
                            {% elif i == 11 %}
                                <label><input type="checkbox" name="building" value="{{ i+1 }}" onchange="updateSelectedBuildings()"> 11Bæ ‹</label>
                            {% elif i == 12 %}
                                <label><input type="checkbox" name="building" value="{{ i+1 }}" onchange="updateSelectedBuildings()"> 12Aæ ‹</label>
                            {% elif i == 13 %}
                                <label><input type="checkbox" name="building" value="{{ i+1 }}" onchange="updateSelectedBuildings()"> 12Bæ ‹</label>
                            {% else %}
                                <label><input type="checkbox" name="building" value="{{ i+1 }}" onchange="updateSelectedBuildings()"> {{ i+1 }}æ ‹</label>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- è¥¿é™¢ -->
            {% if xy_buildings %}
            <div class="building-section">
                <span class="building-label xiyuan">è¥¿é™¢</span>
                {% if has_admin_perm %}<button type="button" class="toggle-btn" onclick="toggleXiyuan()">å…¨é€‰/åé€‰</button>{% endif %}
                <div class="checkbox-grid" id="xiyuan-buildings">
                    {% for v in [15,16,17,18,19,20] %}
                        {% if not allowed_buildings or v|string in allowed_buildings %}
                            <label><input type="checkbox" name="building" value="{{ v }}" onchange="updateSelectedBuildings()"> {{ xy_map[v] }}</label>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="selected-info" id="selectedBuildings"></div>
        </div>

        <!-- æ—¶é—´ + ä¸‹è½½ + æŒ‰é’® å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">æŸ¥è¯¢æ¡ä»¶</div>
            <div class="time-row">
                <div><label for="startTime">å¼€å§‹æ—¶é—´</label><input type="time" id="startTime" name="startTime" required value="23:20:00"></div>
                <div><label for="endTime">ç»“æŸæ—¶é—´</label><input type="time" id="endTime" name="endTime" required value="05:30:00"></div>
            </div>

            <div style="margin-top: 16px; padding-top: 14px; border-top: 1px solid #f0f0f0;">
                <div class="download-area">å¯ä¸‹è½½æ–‡ä»¶ï¼š<a id="downloadFileName"></a></div>
            </div>

            <div class="btn-row">
                <button type="submit" id="submitBtn" class="btn btn-primary">ç¡® å®š</button>
                <button type="button" onclick="resetForm()" class="btn btn-reset">é‡ ç½®</button>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if username == 'admin' %}
        // adminè´¦å·é»˜è®¤é€‰ä¸­ç¬¬4ã€5ã€7ä¸ªå…ƒç´ ï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼‰
        const checkboxes = document.querySelectorAll('.checkbox-grid input[type="checkbox"]');
        const indexesToSelect = [3, 4, 6];
        indexesToSelect.forEach(index => {
            if (checkboxes[index]) {
                checkboxes[index].checked = true;
            }
        });
        {% endif %}
        updateSelectedBuildings();
    });

    function setSubmitBtnLoading(loading) {
        const btn = document.getElementById('submitBtn');
        if (loading) {
            btn.disabled = true;
            btn.textContent = 'æ•°æ®å¤„ç†ä¸­...';
        } else {
            btn.disabled = false;
            btn.textContent = 'ç¡® å®š';
        }
    }

    function handleSubmit(event) {
        event.preventDefault();
        setSubmitBtnLoading(true);

        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;

        fetch('/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                buildings: getSelectedBuildings(),
                startTime: startTime,
                endTime: endTime,
                username: "{{ username }}",
            }),
        })
        .then(response => response.json())
        .then(data => {
            setSubmitBtnLoading(false);
            if (data['status'] == 'success') {
                var file_name = data['file_name'];
                document.getElementById('downloadFileName').href = '/download/' + file_name;
                document.getElementById('downloadFileName').textContent = file_name;
            } else {
                alert('æ•°æ®å¤„ç†å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('æäº¤æŸ¥è¯¢æ—¶å‡ºé”™ï¼');
            setSubmitBtnLoading(false);
        });
    }

    function resetForm() {
        document.getElementById('queryForm').reset();
        document.getElementById('selectedBuildings').textContent = '';
        document.getElementById('downloadFileName').textContent = '';
        document.getElementById('downloadFileName').removeAttribute('href');
        document.getElementById('startTime').value = '23:20:00';
        document.getElementById('endTime').value = '05:30:00';
    }

    function updateSelectedBuildings() {
        const checkboxes = document.querySelectorAll('input[name="building"]:checked');
        const names = Array.from(checkboxes).map(cb => convertBuildingShow(cb.value));
        const el = document.getElementById('selectedBuildings');
        el.textContent = names.length > 0 ? 'å·²é€‰: ã€' + names.join(', ') + 'ã€‘æ ‹å…¬å¯“' : '';
    }

    function getSelectedBuildings() {
        const checkboxes = document.querySelectorAll('input[name="building"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    function convertBuildingShow(bid) {
        const map = {'11':'11A','12':'11B','13':'12A','14':'12B','15':'13','16':'14','17':'15','18':'16','19':'17A','20':'17B'};
        return map[bid] || bid;
    }

    function toggleAllBuildings() {
        const cbs = document.querySelectorAll('input[name="building"]');
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        cbs.forEach(cb => cb.checked = !allChecked);
        updateSelectedBuildings();
    }

    function toggleZhongyuan() {
        const cbs = document.getElementById('zhongyuan-buildings').querySelectorAll('input[name="building"]');
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        cbs.forEach(cb => cb.checked = !allChecked);
        updateSelectedBuildings();
    }

    function toggleXiyuan() {
        const cbs = document.getElementById('xiyuan-buildings').querySelectorAll('input[name="building"]');
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        cbs.forEach(cb => cb.checked = !allChecked);
        updateSelectedBuildings();
    }
</script>
</body>
</html>

