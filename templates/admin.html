<!DOCTYPE html>
<html>
<head>
    <title>ç³»ç»Ÿç®¡ç†</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h2 { margin: 0; }
        .header a { color: red; text-decoration: none; margin-left: 15px; }
        .tabs { display: flex; gap: 0; margin-bottom: 0; border-bottom: 2px solid #4CAF50; }
        .tab-btn { padding: 10px 24px; border: 1px solid #ddd; border-bottom: none; background: #e8e8e8; color: #333; cursor: pointer; font-size: 14px; border-radius: 6px 6px 0 0; margin-right: 2px; }
        .tab-btn:hover { background: #d5d5d5; }
        .tab-btn.active { background: #4CAF50; color: white; border-color: #4CAF50; }
        .tab-content { display: none; background: white; padding: 20px; border: 1px solid #ddd; border-top: none; border-radius: 0 0 6px 6px; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
        th { background: #f0f0f0; }
        .btn { padding: 5px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin: 2px; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-info { background: #2196F3; color: white; }
        .btn-sm { padding: 3px 8px; font-size: 12px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 8px; z-index: 101; min-width: 450px; max-height: 80vh; overflow-y: auto; }
        .modal h3 { margin-top: 0; }
        .form-row { margin-bottom: 12px; }
        .form-row label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 13px; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-row textarea { height: 60px; resize: vertical; }
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 12px; color: white; }
        .status-success { background: #4CAF50; }
        .status-failed { background: #f44336; }
        .status-running { background: #2196F3; }
        .status-pending { background: #9e9e9e; }
        .status-email_failed { background: #ff9800; }
        .toggle-on { color: #4CAF50; font-weight: bold; }
        .toggle-off { color: #999; }
        .toolbar { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .checkbox-group label { font-size: 13px; font-weight: normal; display: inline-flex; align-items: center; gap: 3px; }
        .perm-group { margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px; }
        .perm-group .username { font-weight: bold; margin-bottom: 4px; }
    </style>
</head>
<body>
<div class="header">
    <h2>ç³»ç»Ÿç®¡ç†</h2>
    <div>
        <span>{{ username }}</span>
        <a href="{{ url_for('dashboard') }}">è¿”å›é¢æ¿</a>
        <a href="{{ url_for('logout') }}" style="color:red;">é€€å‡ºç™»å½•</a>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('email-tasks')">é‚®ä»¶ä»»åŠ¡</button>
    <button class="tab-btn" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</button>
    <button class="tab-btn" onclick="switchTab('permissions')">æƒé™ç®¡ç†</button>
    <button class="tab-btn" onclick="switchTab('task-logs')">æ‰§è¡Œè®°å½•</button>
    <button class="tab-btn" onclick="switchTab('config')">ç³»ç»Ÿé…ç½®</button>
    <button class="tab-btn" onclick="switchTab('scheduler')">è°ƒåº¦å™¨</button>
    <button class="tab-btn" onclick="switchTab('operation-logs')">æ“ä½œæ—¥å¿—</button>
</div>

<!-- é‚®ä»¶ä»»åŠ¡ Tab -->
<div id="tab-email-tasks" class="tab-content active">
    <div class="toolbar">
        <h3 style="margin:0;">é‚®ä»¶ä»»åŠ¡é…ç½®</h3>
        <button class="btn btn-primary" onclick="showEmailTaskModal()">+ æ–°å»ºä»»åŠ¡</button>
    </div>
    <table>
        <thead><tr>
            <th>ID</th><th>ä»»åŠ¡åç§°</th><th>ç”¨æˆ·</th><th>æ¥¼æ ‹</th><th>æ”¶ä»¶äºº</th>
            <th>æ—¶é—´æ®µ</th><th>Cron</th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody id="email-tasks-body"></tbody>
    </table>
</div>

<!-- ç”¨æˆ·ç®¡ç† Tab -->
<div id="tab-users" class="tab-content">
    <div class="toolbar">
        <h3 style="margin:0;">ç”¨æˆ·ç®¡ç†</h3>
        <button class="btn btn-primary" onclick="showUserModal()">+ æ–°å»ºç”¨æˆ·</button>
    </div>
    <table>
        <thead><tr><th>ç”¨æˆ·å</th><th>è§’è‰²</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="users-body"></tbody>
    </table>
</div>

<!-- æƒé™ç®¡ç† Tab -->
<div id="tab-permissions" class="tab-content">
    <div class="toolbar"><h3 style="margin:0;">æƒé™ç®¡ç†</h3></div>
    <div id="permissions-container"></div>
</div>

<!-- æ‰§è¡Œè®°å½• Tab -->
<div id="tab-task-logs" class="tab-content">
    <div class="toolbar">
        <h3 style="margin:0;">ä»»åŠ¡æ‰§è¡Œè®°å½•</h3>
        <button class="btn btn-info" onclick="loadTaskLogs()">åˆ·æ–°</button>
    </div>
    <table>
        <thead><tr><th>ID</th><th>ä»»åŠ¡åç§°</th><th>ç”¨æˆ·</th><th>çŠ¶æ€</th><th>æ–‡ä»¶</th><th>é”™è¯¯ä¿¡æ¯</th><th>æ‰§è¡Œæ—¶é—´</th></tr></thead>
        <tbody id="task-logs-body"></tbody>
    </table>
</div>

<!-- ç³»ç»Ÿé…ç½® Tab -->
<div id="tab-config" class="tab-content">
    <div class="toolbar">
        <h3 style="margin:0;">ç³»ç»Ÿé…ç½®</h3>
        <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
    </div>
    <table>
        <thead><tr><th>é…ç½®é¡¹</th><th>å€¼</th><th>è¯´æ˜</th></tr></thead>
        <tbody id="config-body"></tbody>
    </table>
</div>

<!-- è°ƒåº¦å™¨ Tab -->
<div id="tab-scheduler" class="tab-content">
    <div class="toolbar">
        <h3 style="margin:0;">è°ƒåº¦å™¨çŠ¶æ€</h3>
        <div>
            <button class="btn btn-info" onclick="loadSchedulerStatus()">åˆ·æ–°</button>
            <button class="btn btn-warning" onclick="reloadScheduler()">é‡æ–°åŠ è½½</button>
        </div>
    </div>
    <div id="scheduler-info"></div>
</div>

<!-- æ“ä½œæ—¥å¿— Tab -->
<div id="tab-operation-logs" class="tab-content">
    <div class="toolbar">
        <h3 style="margin:0;">æ“ä½œæ—¥å¿—</h3>
        <div>
            <select id="op-log-user-filter" onchange="loadOperationLogs()" style="padding:6px 10px;border:1px solid #ddd;border-radius:4px;margin-right:8px;">
                <option value="">å…¨éƒ¨ç”¨æˆ·</option>
            </select>
            <button class="btn btn-info" onclick="loadOperationLogs()">åˆ·æ–°</button>
        </div>
    </div>
    <table>
        <thead><tr><th>ID</th><th>ç”¨æˆ·</th><th>æ“ä½œ</th><th>è¯¦æƒ…</th><th>IPåœ°å€</th><th>æ—¶é—´</th></tr></thead>
        <tbody id="operation-logs-body"></tbody>
    </table>
</div>

<!-- æ¨¡æ€æ¡†å ä½ -->
<div id="modal-overlay" class="modal-overlay" onclick="closeModal()"></div>
<div id="modal-container"></div>

<script>
// ==================== Tab åˆ‡æ¢ ====================
function switchTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
    // åˆ‡æ¢æ—¶åŠ è½½æ•°æ®
    const loaders = {
        'email-tasks': loadEmailTasks, 'users': loadUsers,
        'permissions': loadPermissions, 'task-logs': loadTaskLogs,
        'config': loadConfig, 'scheduler': loadSchedulerStatus,
        'operation-logs': loadOperationLogs
    };
    if (loaders[name]) loaders[name]();
}

function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
    document.getElementById('modal-container').innerHTML = '';
}

function api(url, method, data) {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (data) opts.body = JSON.stringify(data);
    return fetch(url, opts).then(r => r.json());
}

// ==================== æ¥¼æ ‹æ˜ å°„ ====================
const buildingMap = {
    '1':'1æ ‹','2':'2æ ‹','3':'3æ ‹','4':'4æ ‹','5':'5æ ‹','6':'6æ ‹','7':'7æ ‹',
    '8':'8æ ‹','9':'9æ ‹','10':'10æ ‹','11':'11Aæ ‹','12':'11Bæ ‹','13':'12Aæ ‹','14':'12Bæ ‹',
    '15':'13æ ‹','16':'14æ ‹','17':'15æ ‹','18':'16æ ‹','19':'17Aæ ‹','20':'17Bæ ‹'
};
function buildingLabel(id) { return buildingMap[id] || id + 'æ ‹'; }

function buildingCheckboxes(selected) {
    selected = selected || [];
    let html = '<div style="margin-bottom:6px;font-weight:bold;color:#2196F3;">ä¸­é™¢</div><div class="checkbox-group">';
    for (let i = 1; i <= 14; i++) {
        const checked = selected.includes(String(i)) ? 'checked' : '';
        html += `<label><input type="checkbox" name="building" value="${i}" ${checked}> ${buildingLabel(String(i))}</label>`;
    }
    html += '</div><div style="margin:8px 0 6px;font-weight:bold;color:#4CAF50;">è¥¿é™¢</div><div class="checkbox-group">';
    for (let i = 15; i <= 20; i++) {
        const checked = selected.includes(String(i)) ? 'checked' : '';
        html += `<label><input type="checkbox" name="building" value="${i}" ${checked}> ${buildingLabel(String(i))}</label>`;
    }
    html += '</div>';
    return html;
}

// ==================== é‚®ä»¶ä»»åŠ¡ ====================
function loadEmailTasks() {
    api('/admin/api/email-tasks', 'GET').then(tasks => {
        const tbody = document.getElementById('email-tasks-body');
        tbody.innerHTML = tasks.map(t => `<tr>
            <td>${t.id}</td>
            <td>${t.task_name}</td>
            <td>${t.username}</td>
            <td>${t.buildings.map(b => buildingLabel(b)).join(', ')}</td>
            <td style="font-size:12px;">${t.recipients.join('<br>')}</td>
            <td>${t.start_time} ~ ${t.end_time}</td>
            <td>${t.cron_expression}</td>
            <td><span class="${t.enabled ? 'toggle-on' : 'toggle-off'}">${t.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
            <td>
                <button class="btn btn-info btn-sm" onclick="showEmailTaskModal(${t.id})">ç¼–è¾‘</button>
                <button class="btn btn-warning btn-sm" onclick="triggerTask(${t.id})">æ‰§è¡Œ</button>
                <button class="btn btn-danger btn-sm" onclick="deleteEmailTask(${t.id})">åˆ é™¤</button>
            </td>
        </tr>`).join('');
    });
}

// ç¼“å­˜ç”¨æˆ·åˆ—è¡¨å’Œä»»åŠ¡åˆ—è¡¨ï¼Œä¾›æ¨¡æ€æ¡†ä½¿ç”¨
let _cachedUsers = [];
let _cachedTasks = [];

function showEmailTaskModal(id) {
    const isEdit = !!id;
    // åŒæ—¶åŠ è½½ç”¨æˆ·åˆ—è¡¨ã€æ‰€æœ‰ä»»åŠ¡ã€å½“å‰ç¼–è¾‘ä»»åŠ¡
    Promise.all([
        api('/admin/api/users', 'GET'),
        api('/admin/api/email-tasks', 'GET'),
    ]).then(([users, tasks]) => {
        _cachedUsers = users;
        _cachedTasks = tasks;
        const t = isEdit ? tasks.find(x => x.id === id) : null;
        const d = t || { task_name:'', username:'', buildings:[], recipients:[], subject_prefix:'', start_time:'23:20:00', end_time:'05:30:00', cron_expression:'0 6 * * *', enabled:1 };
        // åˆ¤æ–­å½“å‰ç”¨æˆ·åæ˜¯å¦åœ¨ç”¨æˆ·åˆ—è¡¨ä¸­ï¼ˆç¼–è¾‘æ—¶å†³å®šé»˜è®¤æ¨¡å¼ï¼‰
        const inList = users.some(u => u.username === d.username);
        const defaultMode = (isEdit && d.username && !inList) ? 'manual' : 'select';

        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('modal-container').innerHTML = `<div class="modal">
            <h3>${isEdit ? 'ç¼–è¾‘' : 'æ–°å»º'}é‚®ä»¶ä»»åŠ¡</h3>
            <div class="form-row"><label>ä»»åŠ¡åç§°</label><input id="et-name" value="${d.task_name}"></div>
            <div class="form-row">
                <label>å…³è”ç”¨æˆ·</label>
                <div style="display:flex;gap:12px;margin-bottom:6px;">
                    <label style="font-weight:normal;font-size:13px;cursor:pointer;">
                        <input type="radio" name="et-user-mode" value="select" ${defaultMode==='select'?'checked':''} onchange="switchUserMode('select')"> ä¸‹æ‹‰é€‰æ‹©
                    </label>
                    <label style="font-weight:normal;font-size:13px;cursor:pointer;">
                        <input type="radio" name="et-user-mode" value="manual" ${defaultMode==='manual'?'checked':''} onchange="switchUserMode('manual')"> æ‰‹å·¥è¾“å…¥
                    </label>
                </div>
                <div id="et-user-select-wrap" style="display:${defaultMode==='select'?'block':'none'};">
                    <select id="et-user-select" onchange="onUserSelected()" style="width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:4px;">
                        <option value="">-- è¯·é€‰æ‹©ç”¨æˆ· --</option>
                        ${users.map(u => `<option value="${u.username}" ${u.username===d.username?'selected':''}>${u.username} (${u.role})</option>`).join('')}
                    </select>
                </div>
                <div id="et-user-manual-wrap" style="display:${defaultMode==='manual'?'block':'none'};">
                    <input id="et-user-manual" value="${defaultMode==='manual'?d.username:''}" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
            </div>
            <div class="form-row"><label>æ¥¼æ ‹</label><div id="et-buildings">${buildingCheckboxes(d.buildings)}</div></div>
            <div class="form-row"><label>æ”¶ä»¶äººï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label><textarea id="et-recipients">${d.recipients.join('\n')}</textarea></div>
            <div class="form-row"><label>é‚®ä»¶ä¸»é¢˜å‰ç¼€</label><input id="et-prefix" value="${d.subject_prefix}"></div>
            <div class="form-row" style="display:flex;gap:10px;">
                <div style="flex:1"><label>å¼€å§‹æ—¶é—´</label><input type="time" id="et-start" value="${d.start_time}" step="1"></div>
                <div style="flex:1"><label>ç»“æŸæ—¶é—´</label><input type="time" id="et-end" value="${d.end_time}" step="1"></div>
            </div>
            <div class="form-row"><label>Cron è¡¨è¾¾å¼</label><input id="et-cron" value="${d.cron_expression}" oninput="updateCronDesc()" placeholder="åˆ† æ—¶ æ—¥ æœˆ å‘¨"><div id="et-cron-desc" style="margin-top:4px;font-size:12px;color:#2196F3;"></div></div>
            <div class="form-row"><label><input type="checkbox" id="et-enabled" ${d.enabled ? 'checked' : ''}> å¯ç”¨</label></div>
            <div style="text-align:right;margin-top:15px;">
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEmailTask(${isEdit ? id : 'null'})">${isEdit ? 'ä¿å­˜' : 'åˆ›å»º'}</button>
            </div>
        </div>`;
        updateCronDesc();
    });
}

function updateCronDesc() {
    const el = document.getElementById('et-cron-desc');
    const input = document.getElementById('et-cron');
    if (!el || !input) return;
    el.textContent = parseCronDesc(input.value.trim());
}

function parseCronDesc(expr) {
    if (!expr) return '';
    const parts = expr.split(/\s+/);
    if (parts.length !== 5) return 'âš ï¸ æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º 5 æ®µï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨';
    const [minute, hour, day, month, dow] = parts;

    // å‘¨å‡ æ˜ å°„
    const dowNames = {'0':'æ—¥','1':'ä¸€','2':'äºŒ','3':'ä¸‰','4':'å››','5':'äº”','6':'å…­','7':'æ—¥'};
    function fmtDow(s) {
        // å¤„ç† 1-5, 0,6, * ç­‰
        if (s === '*') return '';
        if (s.includes('-')) {
            const [a, b] = s.split('-');
            return 'å‘¨' + (dowNames[a]||a) + 'åˆ°å‘¨' + (dowNames[b]||b);
        }
        if (s.includes(',')) {
            return s.split(',').map(v => 'å‘¨' + (dowNames[v]||v)).join('ã€');
        }
        return 'å‘¨' + (dowNames[s]||s);
    }
    function fmtTime(h, m) {
        const hh = h.padStart(2, '0'), mm = m.padStart(2, '0');
        const hi = parseInt(h);
        let period = 'å‡Œæ™¨';
        if (hi >= 6 && hi < 12) period = 'ä¸Šåˆ';
        else if (hi === 12) period = 'ä¸­åˆ';
        else if (hi > 12 && hi < 18) period = 'ä¸‹åˆ';
        else if (hi >= 18) period = 'æ™šä¸Š';
        return period + ' ' + hh + ':' + mm;
    }
    function fmtMultiTime(h, m) {
        if (h.includes(',')) {
            return h.split(',').map(v => fmtTime(v, m)).join(' å’Œ ');
        }
        if (h.includes('/')) {
            const interval = h.split('/')[1];
            return 'æ¯éš” ' + interval + ' å°æ—¶';
        }
        return fmtTime(h, m);
    }

    let desc = 'è¯¥ä»»åŠ¡å°†åœ¨';
    // æœˆ
    if (month !== '*') {
        if (month.includes(',')) desc += month.split(',').join('ã€') + ' æœˆçš„';
        else if (month.includes('/')) desc += 'æ¯éš” ' + month.split('/')[1] + ' ä¸ªæœˆçš„';
        else desc += month + ' æœˆçš„';
    }
    // æ—¥
    if (day !== '*') {
        if (day.includes(',')) desc += 'æ¯æœˆ ' + day.split(',').join('ã€') + ' æ—¥ ';
        else if (day.includes('/')) desc += 'æ¯éš” ' + day.split('/')[1] + ' å¤© ';
        else desc += 'æ¯æœˆ ' + day + ' æ—¥ ';
    }
    // å‘¨
    const dowStr = fmtDow(dow);
    if (day === '*' && month === '*') {
        if (dowStr) desc += 'æ¯' + dowStr + ' ';
        else desc += 'æ¯å¤© ';
    } else if (dowStr) {
        desc += dowStr + ' ';
    }
    // æ—¶é—´
    if (minute.includes('/')) {
        desc += 'æ¯éš” ' + minute.split('/')[1] + ' åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡';
    } else if (hour.includes('/')) {
        desc += fmtMultiTime(hour, minute) + 'ï¼ˆ' + minute + ' åˆ†ï¼‰æ‰§è¡Œ';
    } else {
        desc += fmtMultiTime(hour, minute) + ' æ‰§è¡Œ';
    }
    return 'ğŸ’¡ ' + desc;
}

function switchUserMode(mode) {
    document.getElementById('et-user-select-wrap').style.display = mode === 'select' ? 'block' : 'none';
    document.getElementById('et-user-manual-wrap').style.display = mode === 'manual' ? 'block' : 'none';
}

function onUserSelected() {
    const username = document.getElementById('et-user-select').value;
    if (!username) return;
    // æŸ¥æ‰¾è¯¥ç”¨æˆ·å·²æœ‰ä»»åŠ¡çš„æ‰€æœ‰æ¥¼æ ‹ï¼Œåˆå¹¶å»é‡
    const userTasks = _cachedTasks.filter(t => t.username === username);
    if (userTasks.length === 0) return;
    const allBuildings = [...new Set(userTasks.flatMap(t => t.buildings))];
    // æ›´æ–°æ¥¼æ ‹å¤é€‰æ¡†
    document.getElementById('et-buildings').innerHTML = buildingCheckboxes(allBuildings);
}

function getSelectedUsername() {
    const mode = document.querySelector('input[name="et-user-mode"]:checked').value;
    if (mode === 'select') {
        return document.getElementById('et-user-select').value;
    } else {
        return document.getElementById('et-user-manual').value;
    }
}

function saveEmailTask(id) {
    const buildings = Array.from(document.querySelectorAll('#et-buildings input:checked')).map(c => c.value);
    const recipients = document.getElementById('et-recipients').value.split('\n').map(s => s.trim()).filter(Boolean);
    const data = {
        task_name: document.getElementById('et-name').value,
        username: getSelectedUsername(),
        buildings, recipients,
        subject_prefix: document.getElementById('et-prefix').value,
        start_time: document.getElementById('et-start').value,
        end_time: document.getElementById('et-end').value,
        cron_expression: document.getElementById('et-cron').value,
        enabled: document.getElementById('et-enabled').checked,
    };
    const url = id ? `/admin/api/email-tasks/${id}` : '/admin/api/email-tasks';
    const method = id ? 'PUT' : 'POST';
    api(url, method, data).then(r => { if (r.success) { closeModal(); loadEmailTasks(); } else { alert(r.msg); } });
}

function deleteEmailTask(id) {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) return;
    api(`/admin/api/email-tasks/${id}`, 'DELETE').then(() => loadEmailTasks());
}

function triggerTask(id) {
    if (!confirm('ç¡®å®šæ‰‹åŠ¨æ‰§è¡Œæ­¤ä»»åŠ¡ï¼Ÿ')) return;
    api(`/admin/api/trigger-task/${id}`, 'POST').then(r => alert(r.msg || 'å·²è§¦å‘'));
}

// ==================== ç”¨æˆ·ç®¡ç† ====================
function loadUsers() {
    api('/admin/api/users', 'GET').then(users => {
        const tbody = document.getElementById('users-body');
        tbody.innerHTML = users.map(u => `<tr>
            <td>${u.username}</td>
            <td>${u.role}</td>
            <td><span class="${u.enabled ? 'toggle-on' : 'toggle-off'}" style="cursor:pointer;" onclick="toggleUserEnabled('${u.username}', ${u.enabled})">${u.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
            <td>${u.created_at || ''}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick="showUserModal('${u.username}')">ç¼–è¾‘</button>
                <button class="btn btn-danger btn-sm" onclick="deleteUser('${u.username}')">åˆ é™¤</button>
            </td>
        </tr>`).join('');
    });
}

function showUserModal(username) {
    const isEdit = !!username;
    const load = isEdit ? api('/admin/api/users', 'GET').then(us => us.find(u => u.username === username)) : Promise.resolve(null);
    load.then(u => {
        u = u || { username: '', role: 'user', enabled: 1 };
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('modal-container').innerHTML = `<div class="modal">
            <h3>${isEdit ? 'ç¼–è¾‘' : 'æ–°å»º'}ç”¨æˆ·</h3>
            <div class="form-row"><label>ç”¨æˆ·å</label><input id="u-name" value="${u.username}" ${isEdit ? 'readonly style="background:#eee;"' : ''}></div>
            <div class="form-row"><label>å¯†ç ${isEdit ? 'ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰' : ''}</label><input type="password" id="u-pass" value=""></div>
            <div class="form-row"><label>è§’è‰²</label><select id="u-role"><option value="user" ${u.role==='user'?'selected':''}>æ™®é€šç”¨æˆ·</option><option value="admin" ${u.role==='admin'?'selected':''}>ç®¡ç†å‘˜</option></select></div>
            <div class="form-row"><label><input type="checkbox" id="u-enabled" ${u.enabled ? 'checked' : ''}> å¯ç”¨</label></div>
            <div style="text-align:right;margin-top:15px;">
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveUser(${isEdit ? `'${u.username}'` : 'null'})">${isEdit ? 'ä¿å­˜' : 'åˆ›å»º'}</button>
            </div>
        </div>`;
    });
}

function saveUser(username) {
    const data = {
        username: document.getElementById('u-name').value,
        password: document.getElementById('u-pass').value,
        role: document.getElementById('u-role').value,
        enabled: document.getElementById('u-enabled').checked,
    };
    if (!username) {
        if (!data.username || !data.password) { alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'); return; }
        api('/admin/api/users', 'POST', data).then(r => { if (r.success) { closeModal(); loadUsers(); } else { alert(r.msg); } });
    } else {
        api(`/admin/api/users/${username}`, 'PUT', data).then(r => { if (r.success) { closeModal(); loadUsers(); } else { alert(r.msg); } });
    }
}

function deleteUser(username) {
    if (!confirm(`ç¡®å®šåˆ é™¤ç”¨æˆ· ${username}ï¼Ÿ`)) return;
    api(`/admin/api/users/${username}`, 'DELETE').then(r => { if (r.success) loadUsers(); else alert(r.msg); });
}

function toggleUserEnabled(username, current) {
    api(`/admin/api/users/${username}`, 'PUT', { enabled: !current }).then(r => { if (r.success) loadUsers(); });
}

// ==================== æƒé™ç®¡ç† ====================
const allPermissions = [
    { key: 'query', label: 'æŸ¥è¯¢æ•°æ®' },
    { key: 'download', label: 'ä¸‹è½½æ–‡ä»¶' },
    { key: 'admin', label: 'ç®¡ç†é¡µé¢' },
    { key: 'trigger_task', label: 'è§¦å‘ä»»åŠ¡' },
];

const allBuildings = [
    { value: '1', label: '1æ ‹', group: 'ä¸­é™¢' },
    { value: '2', label: '2æ ‹', group: 'ä¸­é™¢' },
    { value: '3', label: '3æ ‹', group: 'ä¸­é™¢' },
    { value: '4', label: '4æ ‹', group: 'ä¸­é™¢' },
    { value: '5', label: '5æ ‹', group: 'ä¸­é™¢' },
    { value: '6', label: '6æ ‹', group: 'ä¸­é™¢' },
    { value: '7', label: '7æ ‹', group: 'ä¸­é™¢' },
    { value: '8', label: '8æ ‹', group: 'ä¸­é™¢' },
    { value: '9', label: '9æ ‹', group: 'ä¸­é™¢' },
    { value: '10', label: '10æ ‹', group: 'ä¸­é™¢' },
    { value: '11', label: '11Aæ ‹', group: 'ä¸­é™¢' },
    { value: '12', label: '11Bæ ‹', group: 'ä¸­é™¢' },
    { value: '13', label: '12Aæ ‹', group: 'ä¸­é™¢' },
    { value: '14', label: '12Bæ ‹', group: 'ä¸­é™¢' },
    { value: '15', label: '13æ ‹', group: 'è¥¿é™¢' },
    { value: '16', label: '14æ ‹', group: 'è¥¿é™¢' },
    { value: '17', label: '15æ ‹', group: 'è¥¿é™¢' },
    { value: '18', label: '16æ ‹', group: 'è¥¿é™¢' },
    { value: '19', label: '17Aæ ‹', group: 'è¥¿é™¢' },
    { value: '20', label: '17Bæ ‹', group: 'è¥¿é™¢' },
];

function loadPermissions() {
    api('/admin/api/users', 'GET').then(users => {
        const permPromises = users.map(u => api(`/admin/api/permissions/${u.username}`, 'GET'));
        const bldPromises = users.map(u => api(`/admin/api/buildings/${u.username}`, 'GET'));
        return Promise.all([Promise.resolve(users), api('/admin/api/permissions', 'GET'), Promise.all(bldPromises)]);
    }).then(([users, perms, bldResults]) => {
        const container = document.getElementById('permissions-container');
        container.innerHTML = users.map((u, idx) => {
            const userPerms = perms.filter(p => p.username === u.username).map(p => p.permission);
            const userBlds = bldResults[idx].buildings || [];
            const isAllBuildings = userBlds.length === 0;
            const zhongyuan = allBuildings.filter(b => b.group === 'ä¸­é™¢');
            const xiyuan = allBuildings.filter(b => b.group === 'è¥¿é™¢');
            return `<div class="perm-group">
                <div class="username">${u.username} <span style="color:#999;font-size:12px;">(${u.role})</span></div>
                <div style="margin-bottom:8px;">
                    <span style="font-size:12px;color:#666;font-weight:bold;">åŠŸèƒ½æƒé™ï¼š</span>
                    <div class="checkbox-group" style="margin-top:4px;">
                        ${allPermissions.map(p => `<label><input type="checkbox" data-user="${u.username}" data-perm="${p.key}" ${userPerms.includes(p.key) ? 'checked' : ''}> ${p.label}</label>`).join('')}
                    </div>
                </div>
                <div style="margin-bottom:8px;">
                    <span style="font-size:12px;color:#666;font-weight:bold;">æ¥¼æ ‹æƒé™ï¼š</span>
                    <label style="font-size:12px;margin-left:8px;"><input type="checkbox" data-user="${u.username}" data-allbld ${isAllBuildings ? 'checked' : ''} onchange="toggleAllBld('${u.username}', this.checked)"> å…¨éƒ¨æ¥¼æ ‹</label>
                    <div id="bld-grid-${u.username}" class="checkbox-group" style="margin-top:4px;${isAllBuildings ? 'display:none;' : ''}">
                        <span style="font-size:11px;color:#1565C0;font-weight:bold;margin-right:4px;">ä¸­é™¢:</span>
                        ${zhongyuan.map(b => `<label><input type="checkbox" data-user="${u.username}" data-bld="${b.value}" ${isAllBuildings || userBlds.includes(b.value) ? 'checked' : ''}> ${b.label}</label>`).join('')}
                        <span style="font-size:11px;color:#2E7D32;font-weight:bold;margin-left:8px;margin-right:4px;">è¥¿é™¢:</span>
                        ${xiyuan.map(b => `<label><input type="checkbox" data-user="${u.username}" data-bld="${b.value}" ${isAllBuildings || userBlds.includes(b.value) ? 'checked' : ''}> ${b.label}</label>`).join('')}
                    </div>
                </div>
                <button class="btn btn-primary btn-sm" style="margin-top:6px;" onclick="savePermissions('${u.username}')">ä¿å­˜</button>
            </div>`;
        }).join('');
    });
}

function toggleAllBld(username, checked) {
    const grid = document.getElementById('bld-grid-' + username);
    grid.style.display = checked ? 'none' : 'flex';
    if (checked) {
        grid.querySelectorAll('input[data-bld]').forEach(cb => cb.checked = true);
    }
}

function savePermissions(username) {
    const perms = Array.from(document.querySelectorAll(`input[data-user="${username}"][data-perm]:checked`)).map(c => c.dataset.perm);
    const isAllBld = document.querySelector(`input[data-user="${username}"][data-allbld]`).checked;
    const buildings = isAllBld ? [] : Array.from(document.querySelectorAll(`input[data-user="${username}"][data-bld]:checked`)).map(c => c.dataset.bld);
    Promise.all([
        api(`/admin/api/permissions/${username}`, 'PUT', { permissions: perms }),
        api(`/admin/api/buildings/${username}`, 'PUT', { buildings: buildings })
    ]).then(([r1, r2]) => {
        if (r1.success && r2.success) alert('æƒé™å·²ä¿å­˜');
        else alert('ä¿å­˜å¤±è´¥');
    });
}


// ==================== ä»»åŠ¡æ‰§è¡Œè®°å½• ====================
function loadTaskLogs() {
    api('/admin/api/task-logs?limit=100', 'GET').then(logs => {
        const tbody = document.getElementById('task-logs-body');
        tbody.innerHTML = logs.map(l => {
            const statusClass = 'status-' + (l.status || 'pending');
            const statusText = { success:'æˆåŠŸ', failed:'å¤±è´¥', running:'æ‰§è¡Œä¸­', email_failed:'é‚®ä»¶å¤±è´¥' }[l.status] || l.status;
            return `<tr>
                <td>${l.id}</td>
                <td>${l.task_name || ''}</td>
                <td>${l.username || ''}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td style="font-size:12px;">${l.file_path || '-'}</td>
                <td style="font-size:12px;color:#f44336;">${l.error_message || '-'}</td>
                <td>${l.created_at || ''}</td>
            </tr>`;
        }).join('');
    });
}

// ==================== ç³»ç»Ÿé…ç½® ====================
function escapeHtmlAttr(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function loadConfig() {
    api('/admin/api/config', 'GET').then(configs => {
        const tbody = document.getElementById('config-body');
        tbody.innerHTML = configs.map(c => {
            const val = escapeHtmlAttr(c.config_value || '');
            const isPassword = c.config_key.includes('password');
            return `<tr>
                <td><strong>${c.config_key}</strong></td>
                <td><input class="config-input" data-key="${c.config_key}" value="${val}" ${isPassword ? 'type="password"' : ''} style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:3px;"></td>
                <td style="font-size:12px;color:#666;">${c.description || ''}</td>
            </tr>`;
        }).join('');
    });
}

function saveConfig() {
    const inputs = document.querySelectorAll('.config-input');
    const data = Array.from(inputs).map(inp => ({
        config_key: inp.dataset.key,
        config_value: inp.value,
    }));
    api('/admin/api/config', 'PUT', data).then(r => { if (r.success) alert('é…ç½®å·²ä¿å­˜'); else alert(r.msg || 'ä¿å­˜å¤±è´¥'); });
}

// ==================== è°ƒåº¦å™¨ ====================
function loadSchedulerStatus() {
    api('/admin/api/scheduler/status', 'GET').then(data => {
        const info = document.getElementById('scheduler-info');
        let html = `<p><strong>è¿è¡ŒçŠ¶æ€ï¼š</strong><span class="${data.running ? 'toggle-on' : 'toggle-off'}">${data.running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}</span></p>`;
        if (data.jobs && data.jobs.length > 0) {
            html += '<table><thead><tr><th>ä»»åŠ¡ID</th><th>ä»»åŠ¡åç§°</th><th>ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´</th></tr></thead><tbody>';
            html += data.jobs.map(j => `<tr><td>${j.id}</td><td>${j.name}</td><td>${j.next_run_time || 'æ— '}</td></tr>`).join('');
            html += '</tbody></table>';
        } else {
            html += '<p style="color:#999;">æš‚æ— è°ƒåº¦ä»»åŠ¡</p>';
        }
        info.innerHTML = html;
    });
}

function reloadScheduler() {
    if (!confirm('ç¡®å®šé‡æ–°åŠ è½½è°ƒåº¦å™¨ï¼Ÿ')) return;
    api('/admin/api/scheduler/reload', 'POST').then(r => {
        alert(r.msg || 'æ“ä½œå®Œæˆ');
        loadSchedulerStatus();
    });
}

// ==================== æ“ä½œæ—¥å¿— ====================
function loadOperationLogs() {
    const filterUser = document.getElementById('op-log-user-filter').value;
    let url = '/admin/api/operation-logs?limit=200';
    if (filterUser) url += '&username=' + encodeURIComponent(filterUser);
    // åŒæ—¶åŠ è½½ç”¨æˆ·åˆ—è¡¨å¡«å……ä¸‹æ‹‰æ¡†
    Promise.all([api(url, 'GET'), api('/admin/api/users', 'GET')]).then(([logs, users]) => {
        const select = document.getElementById('op-log-user-filter');
        const currentVal = select.value;
        // åªåœ¨é€‰é¡¹ä¸ºç©ºæ—¶å¡«å……ç”¨æˆ·åˆ—è¡¨
        if (select.options.length <= 1) {
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = u.username;
                select.appendChild(opt);
            });
            select.value = currentVal;
        }
        const actionLabels = {
            'login': 'ç™»å½•', 'logout': 'ç™»å‡º', 'login_failed': 'ç™»å½•å¤±è´¥',
            'query': 'æŸ¥è¯¢æ•°æ®', 'download': 'ä¸‹è½½æ–‡ä»¶',
            'create_user': 'åˆ›å»ºç”¨æˆ·', 'update_user': 'ä¿®æ”¹ç”¨æˆ·', 'delete_user': 'åˆ é™¤ç”¨æˆ·',
            'update_permissions': 'ä¿®æ”¹æƒé™', 'update_buildings': 'ä¿®æ”¹æ¥¼æ ‹æƒé™',
            'create_email_task': 'åˆ›å»ºé‚®ä»¶ä»»åŠ¡', 'update_email_task': 'ä¿®æ”¹é‚®ä»¶ä»»åŠ¡', 'delete_email_task': 'åˆ é™¤é‚®ä»¶ä»»åŠ¡',
            'trigger_task': 'è§¦å‘ä»»åŠ¡', 'update_config': 'æ›´æ–°é…ç½®', 'reload_scheduler': 'é‡è½½è°ƒåº¦å™¨'
        };
        const tbody = document.getElementById('operation-logs-body');
        tbody.innerHTML = logs.map(l => {
            const actionText = actionLabels[l.action] || l.action;
            const isError = l.action === 'login_failed';
            return `<tr>
                <td>${l.id}</td>
                <td>${l.username || '-'}</td>
                <td>${actionText}</td>
                <td style="font-size:12px;">${l.detail || '-'}</td>
                <td style="font-size:12px;">${l.ip_address || '-'}</td>
                <td>${l.created_at || ''}</td>
            </tr>`;
        }).join('');
    });
}

// ==================== é¡µé¢åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', function() {
    loadEmailTasks();
});
</script>
</body>
</html>