# 系统管理页面使用说明

## 访问方式

1. 使用管理员账号（`role=admin`）登录系统
2. 在 Dashboard 页面点击右上角 **「系统管理」** 链接，或直接访问 `/admin/`

> 只有角色为 `admin` 的用户才能进入管理页面，普通用户访问会被重定向到 Dashboard。

---

## 首次使用配置流程

首次部署后，按以下顺序完成配置：

```
步骤1 → 系统配置：填写 SMTP 邮件服务器信息（发件邮箱、授权码等）
步骤2 → 系统配置：确认公寓管理系统凭据（tust_username / tust_password）正确
步骤3 → 邮件任务：新建一条邮件任务（选择楼栋、填写收件人、设置执行时间）
步骤4 → 邮件任务：点击「执行」按钮手动触发一次，验证是否正常
步骤5 → 执行记录：查看执行结果，确认状态为「成功」
步骤6 → 系统配置：将 scheduler_enabled 改为 true
步骤7 → 调度器：点击「重新加载」启动定时调度
```

之后任务会按设定的 Cron 表达式自动执行，无需人工干预。

---

## 页面功能说明

管理页面共 6 个 Tab，点击顶部标签切换。

### 1. 邮件任务

管理自动查询并发送邮件的定时任务。

**新建/编辑任务时需要填写：**

| 字段 | 说明 | 示例 |
|------|------|------|
| 任务名称 | 任务的描述性名称 | 每日晚归数据-中院 |
| 关联用户 | 用哪个系统用户身份执行任务 | admin |
| 楼栋 | 勾选要查询的公寓楼栋（分中院/西院两组） | 1栋、2栋、3栋 |
| 收件人 | 邮件接收地址，每行一个 | zhangsan@qq.com |
| 邮件主题前缀 | 邮件标题的前缀文字（可选） | 【晚归通报】 |
| 开始时间 | 查询晚归数据的起始时间 | 23:20:00 |
| 结束时间 | 查询晚归数据的截止时间 | 05:30:00 |
| Cron 表达式 | 定时执行的时间规则 | 0 6 * * *（每天6点） |
| 启用 | 是否参与定时调度 | 勾选 = 启用 |

**操作按钮：**
- **编辑**：修改任务配置
- **执行**：立即手动触发一次任务（不受 Cron 和启用状态限制）
- **删除**：删除任务

**常用 Cron 表达式：**

| 表达式 | 含义 |
|--------|------|
| `0 6 * * *` | 每天早上 6:00 |
| `30 7 * * *` | 每天早上 7:30 |
| `0 6 * * 1-5` | 工作日（周一到周五）早上 6:00 |
| `0 6,18 * * *` | 每天 6:00 和 18:00 各执行一次 |

### 2. 用户管理

管理系统登录账号。

- **新建用户**：填写用户名、密码、角色（管理员/普通用户）
- **编辑用户**：修改密码（留空则不修改）、角色、启用状态
- **启用/禁用**：点击状态文字可快速切换，禁用后该用户无法登录
- **删除用户**：不能删除当前登录的自己

| 角色 | 说明 |
|------|------|
| admin | 管理员，可访问管理页面 |
| user | 普通用户，只能使用 Dashboard 功能 |

### 3. 权限管理

控制每个用户可以执行的操作。页面会列出所有用户，每个用户下方有权限复选框。

| 权限标识 | 说明 |
|----------|------|
| 查询数据 | 允许在 Dashboard 发起数据查询 |
| 下载文件 | 允许下载生成的 Excel 文件 |
| 管理页面 | 允许访问系统管理页面（需配合 admin 角色） |
| 触发任务 | 允许手动触发邮件任务执行 |

修改后点击对应用户的 **「保存」** 按钮生效。

### 4. 执行记录

查看邮件任务的历史执行情况，按时间倒序排列。

| 列 | 说明 |
|----|------|
| 任务名称 | 执行的是哪个邮件任务 |
| 用户 | 以哪个用户身份执行 |
| 状态 | 成功（绿色）/ 失败（红色）/ 执行中（蓝色）/ 邮件失败（橙色） |
| 文件 | 生成的 Excel 文件路径 |
| 错误信息 | 失败时的错误详情 |
| 执行时间 | 任务开始执行的时间 |

点击 **「刷新」** 获取最新记录。

### 5. 系统配置

以表格形式管理所有系统级配置项，修改后点击 **「保存配置」** 批量保存。

**配置项分类：**

| 分类 | 配置项 | 说明 |
|------|--------|------|
| 公寓系统 | tust_username / tust_password | 公寓管理系统的登录凭据 |
| 运行环境 | env | test（本地开发）或 prod（生产环境） |
| Chrome | chrome_binary_path / chromedriver_path | 浏览器路径，空值让 Selenium 自动管理 |
| Chrome | chrome_binary_path_prod / chromedriver_path_prod | 生产环境浏览器路径 |
| 分页 | pagesize | 每页查询数据条数 |
| 时间 | begin_time / end_time | 默认查询时间范围 |
| 邮件 | smtp_server / smtp_port | SMTP 服务器地址和端口 |
| 邮件 | sender_email / sender_password | 发件人邮箱和密码（授权码） |
| 邮件 | smtp_use_tls | 是否启用 TLS 加密（true/false） |
| 调度器 | scheduler_enabled | 是否启用定时调度（true/false） |
| 调度器 | scheduler_timezone | 调度器时区，默认 Asia/Shanghai |
| 数据映射 | bid_dict | 楼栋编号到系统内部 ID 的映射（JSON） |
| 数据映射 | data_cfg | 学院全称到简称的映射（JSON） |

> ⚠️ 密码类字段（sender_password、tust_password）显示为密码输入框，输入时不可见。

### 6. 调度器

查看和控制定时任务调度器的运行状态。

- **运行状态**：显示调度器是否正在运行
- **任务列表**：显示当前已注册的定时任务及下次执行时间
- **刷新**：重新获取调度器状态
- **重新加载**：当修改了邮件任务的 Cron 表达式、启用/禁用状态，或修改了 `scheduler_enabled` 配置后，需要点击此按钮让调度器重新读取配置

---

## 常见问题

### Q1: 手动执行任务成功，但定时任务不执行？

检查以下两项：
1. **系统配置** Tab → `scheduler_enabled` 是否为 `true`
2. **调度器** Tab → 状态是否为「运行中」，如果不是，点击「重新加载」

### Q2: 邮件发送失败？

检查 **系统配置** Tab 中的邮件相关配置：
- `smtp_server` 和 `smtp_port` 是否正确（QQ 邮箱：smtp.qq.com / 587）
- `sender_email` 是否填写了完整邮箱地址
- `sender_password` 是否使用了邮箱的 **授权码**（不是登录密码）
- `smtp_use_tls` 是否为 `true`

### Q3: 修改了任务配置后没有生效？

修改邮件任务的 Cron 表达式或启用状态后，需要到 **调度器** Tab 点击 **「重新加载」**，调度器才会按新配置执行。

### Q4: 如何查看任务是否正常执行？

到 **执行记录** Tab 查看，每次任务执行（无论手动还是定时）都会生成一条记录，包含状态和错误信息。

